name: ğŸ“¥ Download And Push Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'è¦æ“ä½œçš„ Release æ ‡ç­¾å (å¿…é¡»å·²å­˜åœ¨)'
        required: true
      file_urls:
        description: |
          è¦ä¸‹è½½å¹¶ä¸Šä¼ çš„æ–‡ä»¶URLåˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªé“¾æ¥ã€‚
          æ ¼å¼ï¼šURL|æ–‡ä»¶å (å¯é€‰)
          ç¤ºä¾‹ï¼š
          https://example.com/file1.zip|my-file.zip
          https://example.com/file2.tar.gz
        required: true
        type: textarea

jobs:
  check-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ æ‰“å°è¾“å…¥å‚æ•°
        run: |
          echo "ç›®æ ‡ Release æ ‡ç­¾: ${{ github.event.inputs.release_tag }}"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          echo "${{ github.event.inputs.file_urls }}"

      - name: ğŸ” æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.event.inputs.release_tag }}
        run: |
          # ä½¿ç”¨GH CLIæ£€æŸ¥è¯¥æ ‡ç­¾çš„Releaseæ˜¯å¦å­˜åœ¨
          if gh release view "$TAG_NAME" > /dev/null 2>&1; then
              echo "Release $TAG_NAME å­˜åœ¨ã€‚"
              echo "release_exists=true" >> $GITHUB_OUTPUT
          else
              echo "Release $TAG_NAME ä¸å­˜åœ¨ã€‚"
              echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—‚ï¸ åˆ›å»ºä¸‹è½½ç›®å½• (ä»…å½“Releaseå­˜åœ¨æ—¶)
        if: steps.check_release.outputs.release_exists == 'true'
        run: mkdir -p downloaded_files

      - name: ğŸ“¥ è§£æå¹¶ä¸‹è½½å¤šä¸ªæ–‡ä»¶ (ä»…å½“Releaseå­˜åœ¨æ—¶)
        if: steps.check_release.outputs.release_exists == 'true'
        run: |
          # å°†æ–‡æœ¬åŒºåŸŸçš„è¾“å…¥æŒ‰è¡Œåˆ†å‰²æˆæ•°ç»„
          IFS=$'\n' read -d '' -r -a urls <<< "${{ github.event.inputs.file_urls }}"
          
          for line in "${urls[@]}"; do
            # å»é™¤å‰åç©ºæ ¼
            line_clean=$(echo "$line" | xargs)
            
            # è·³è¿‡ç©ºè¡Œ
            if [ -z "$line_clean" ]; then
              continue
            fi

            # è§£æURLå’Œè‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¦‚æœæä¾›äº†ï¼‰
            if echo "$line_clean" | grep -q '|'; then
              url=$(echo "$line_clean" | cut -d'|' -f1 | xargs)
              filename=$(echo "$line_clean" | cut -d'|' -f2 | xargs)
            else
              url="$line_clean"
              # ä»URLä¸­æå–æ–‡ä»¶å
              filename=$(basename "$url" | cut -d'?' -f1)
            fi

            echo "æ­£åœ¨ä¸‹è½½: $url â†’ downloaded_files/$filename"
            
            curl -L -o "downloaded_files/$filename" "$url"
           
            if [ $? -eq 0 ] && [ -f "downloaded_files/$filename" ]; then
              file_size=$(du -h "downloaded_files/$filename" | cut -f1)
              echo "âœ“ ä¸‹è½½æˆåŠŸ: $filename ($file_size)"
            else
              echo "âœ— ä¸‹è½½å¤±è´¥: $url"
              exit 1
            fi
          done

      - name: â¬†ï¸ ä¸Šä¼ æ–‡ä»¶åˆ°å·²å­˜åœ¨çš„Release (ä»…å½“Releaseå­˜åœ¨æ—¶)
        if: steps.check_release.outputs.release_exists == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: downloaded_files/*
          tag_name: ${{ github.event.inputs.release_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âŒ æç¤ºReleaseä¸å­˜åœ¨ (ä»…å½“Releaseä¸å­˜åœ¨æ—¶)
        if: steps.check_release.outputs.release_exists == 'false'
        run: |
          echo "é”™è¯¯: æ ‡ç­¾ä¸º '${{ github.event.inputs.release_tag }}' çš„ Release ä¸å­˜åœ¨ã€‚"
          echo "è¯·å…ˆåœ¨GitHubä¸Šåˆ›å»ºè¯¥Releaseï¼Œæˆ–è€…æ£€æŸ¥æ ‡ç­¾åæ˜¯å¦æ­£ç¡®ã€‚"
          exit 1
